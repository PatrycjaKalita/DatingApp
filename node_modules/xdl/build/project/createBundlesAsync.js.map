{"version":3,"sources":["../../src/project/createBundlesAsync.ts"],"names":["MINIMUM_BUNDLE_SIZE","printBundleSizes","bundles","files","ios","hermesBytecodeBundle","push","code","android","hermesSourcemap","chalk","dim","map","logger","global","info","TableText","createFilesTable","createBundlesAsync","projectRoot","publishOptions","bundleOptions","useDevServer","options","nonPersistent","maxWorkers","target","reset","resetCache","verbose","quiet","fetchPublishBundlesAsync","config","skipSDKVersionRequirement","isLegacy","exp","platforms","undefined","ProjectUtils","getLogger","platform","entryPoint","dev","opts","publishUrl","UrlUtils","constructPublishUrlAsync","sourceMapUrl","constructSourceMapUrlAsync","assetsUrl","constructAssetsUrlAsync","iosBundle","_getForPlatformAsync","errorCode","minLength","androidBundle","iosSourceMap","androidSourceMap","iosAssetsJson","androidAssetsJson","assets","JSON","parse","url","fullUrl","response","axios","request","responseType","transformResponse","data","proxy","validateStatus","status","headers","error","body","e","logError","message","XDLError","length"],"mappings":"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","sourcesContent":["import { getConfig, isLegacyImportsEnabled, Platform } from '@expo/config';\nimport { bundleAsync, BundleOutput } from '@expo/dev-server';\nimport axios from 'axios';\nimport chalk from 'chalk';\n\nimport {\n  ErrorCode,\n  learnMore,\n  Logger as logger,\n  ProjectUtils,\n  PublishOptions,\n  resolveEntryPoint,\n  startReactNativeServerAsync,\n  stopReactNativeServerAsync,\n  TableText,\n  UrlUtils,\n  XDLError,\n} from '../internal';\n\nconst MINIMUM_BUNDLE_SIZE = 500;\n\ntype PackagerOptions = {\n  dev: boolean;\n  minify: boolean;\n};\n\nexport function printBundleSizes(bundles: { android?: BundleOutput; ios?: BundleOutput }) {\n  const files: [string, string | Uint8Array][] = [];\n\n  if (bundles.ios?.hermesBytecodeBundle) {\n    files.push(['index.ios.js (Hermes)', bundles.ios.hermesBytecodeBundle]);\n  } else if (bundles.ios?.code) {\n    files.push(['index.ios.js', bundles.ios.code]);\n  }\n  if (bundles.android?.hermesBytecodeBundle) {\n    files.push(['index.android.js (Hermes)', bundles.android.hermesBytecodeBundle]);\n  } else if (bundles.android?.code) {\n    files.push(['index.android.js', bundles.android.code]);\n  }\n\n  // Account for inline source maps\n  if (bundles.ios?.hermesSourcemap) {\n    files.push([chalk.dim('index.ios.js.map (Hermes)'), bundles.ios.hermesSourcemap]);\n  } else if (bundles.ios?.map) {\n    files.push([chalk.dim('index.ios.js.map'), bundles.ios.map]);\n  }\n  if (bundles.android?.hermesSourcemap) {\n    files.push([chalk.dim('index.android.js.map (Hermes)'), bundles.android.hermesSourcemap]);\n  } else if (bundles.android?.map) {\n    files.push([chalk.dim('index.android.js.map'), bundles.android.map]);\n  }\n\n  logger.global.info('');\n  logger.global.info(TableText.createFilesTable(files));\n  logger.global.info('');\n  logger.global.info(\n    `ðŸ’¡ JavaScript bundle sizes affect startup time. ${chalk.dim(\n      learnMore(`https://expo.fyi/javascript-bundle-sizes`)\n    )}`\n  );\n  logger.global.info('');\n}\n\nexport async function createBundlesAsync(\n  projectRoot: string,\n  publishOptions: PublishOptions = {},\n  bundleOptions: { dev?: boolean; useDevServer: boolean }\n): Promise<{ android: BundleOutput; ios: BundleOutput }> {\n  if (!bundleOptions.useDevServer) {\n    try {\n      await startReactNativeServerAsync({\n        projectRoot,\n        options: {\n          nonPersistent: true,\n          maxWorkers: publishOptions.maxWorkers,\n          target: publishOptions.target,\n          reset: publishOptions.resetCache,\n        },\n        verbose: !publishOptions.quiet,\n      });\n      return await fetchPublishBundlesAsync(projectRoot);\n    } finally {\n      await stopReactNativeServerAsync(projectRoot);\n    }\n  }\n\n  const config = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  const isLegacy = isLegacyImportsEnabled(config.exp);\n  const platforms: Platform[] = ['android', 'ios'];\n  const [android, ios] = await bundleAsync(\n    projectRoot,\n    config.exp,\n    {\n      // If not legacy, ignore the target option to prevent warnings from being thrown.\n      target: !isLegacy ? undefined : publishOptions.target,\n      resetCache: publishOptions.resetCache,\n      logger: ProjectUtils.getLogger(projectRoot),\n      quiet: publishOptions.quiet,\n    },\n    platforms.map((platform: Platform) => ({\n      platform,\n      entryPoint: resolveEntryPoint(projectRoot, platform),\n      dev: bundleOptions.dev,\n    }))\n  );\n\n  return {\n    android,\n    ios,\n  };\n}\n\n// Fetch iOS and Android bundles for publishing\nasync function fetchPublishBundlesAsync(projectRoot: string, opts?: PackagerOptions) {\n  const entryPoint = resolveEntryPoint(projectRoot);\n  const publishUrl = await UrlUtils.constructPublishUrlAsync(\n    projectRoot,\n    entryPoint,\n    undefined,\n    opts\n  );\n  const sourceMapUrl = await UrlUtils.constructSourceMapUrlAsync(projectRoot, entryPoint);\n  const assetsUrl = await UrlUtils.constructAssetsUrlAsync(projectRoot, entryPoint);\n\n  logger.global.info('Building iOS bundle');\n  const iosBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building Android bundle');\n  const androidBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building source maps');\n  const iosSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n  const androidSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building asset maps');\n  const iosAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'ios', {\n    errorCode: 'INVALID_ASSETS',\n  });\n  const androidAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'android', {\n    errorCode: 'INVALID_ASSETS',\n  });\n\n  return {\n    android: { code: androidBundle, map: androidSourceMap, assets: JSON.parse(androidAssetsJson) },\n    ios: { code: iosBundle, map: iosSourceMap, assets: JSON.parse(iosAssetsJson) },\n  };\n}\n\nasync function _getForPlatformAsync(\n  projectRoot: string,\n  url: string,\n  platform: Platform,\n  { errorCode, minLength }: { errorCode: ErrorCode; minLength?: number }\n): Promise<string> {\n  const fullUrl = `${url}&platform=${platform}`;\n  let response;\n\n  try {\n    response = await axios.request({\n      url: fullUrl,\n      responseType: 'text',\n      // Workaround for https://github.com/axios/axios/issues/907.\n      // Without transformResponse, axios will parse the body as JSON regardless of the responseType/\n      transformResponse: [data => data],\n      proxy: false,\n      validateStatus: status => status === 200,\n      headers: {\n        'Exponent-Platform': platform,\n      },\n    });\n  } catch (error) {\n    if (error.response) {\n      if (error.response.data) {\n        let body;\n        try {\n          body = JSON.parse(error.response.data);\n        } catch (e) {\n          ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n        }\n\n        if (body) {\n          if (body.message) {\n            ProjectUtils.logError(projectRoot, 'expo', body.message);\n          } else {\n            ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n          }\n        }\n      }\n      throw new XDLError(\n        errorCode,\n        `Packager URL ${fullUrl} returned unexpected code ${error.response.status}. ` +\n          'Please open your project in the Expo app and see if there are any errors. ' +\n          'Also scroll up and make sure there were no errors or warnings when opening your project.'\n      );\n    } else {\n      throw error;\n    }\n  }\n\n  if (!response.data || (minLength && response.data.length < minLength)) {\n    throw new XDLError(errorCode, `Body is: ${response.data}`);\n  }\n\n  return response.data;\n}\n"],"file":"createBundlesAsync.js"}